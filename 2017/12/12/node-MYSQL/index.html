<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <link rel="shortcut icon" href="/images/mylogo.jpg">
    <title>ZDM的杂货铺</title>
    <link rel="stylesheet" href="/css/fontAawesome/css/font-awesome.css">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header class="header">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/images/mylogo.png" alt="">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="fa fa-bars"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarColor01">
                <ul class="navbar-nav mr-auto">
                    
                    <li class="menu-item">
                        <a href="/" class="nav-link" >首页</a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/archives" class="nav-link" >归档</a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/about" class="nav-link" >关于</a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="https://github.com/zhaodongming" class="nav-link" >开源地址</a>
                    </li>
                    

                </ul>
            </div>
        </div>
    </nav>
</header>
<main class="main">
    
<section>
    <div  class="container">
        <div class="main">
            <article class="post">
                <div class="posticon">
                    <img src="/images/jslogo.jpg" alt="">
                </div>
                <div class="posttitle">
                    <h1>node-MYSQL</h1>
                    <p>by 明 on 2017-12-12 </p>
                </div>
                <div class="post-content">
                    <h2 id="安装node-mysql"><a href="#安装node-mysql" class="headerlink" title="安装node-mysql"></a>安装node-mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install mysql</span><br></pre></td></tr></table></figure>
<h2 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h2><p>推荐的建立连接的方式是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var mysql      = require(<span class="string">'mysql'</span>);</span><br><span class="line">var connection = mysql.createConnection(&#123;</span><br><span class="line">  host     : <span class="string">'example.org'</span>,</span><br><span class="line">  user     : <span class="string">'bob'</span>,</span><br><span class="line">  password : <span class="string">'secret'</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">connection.connect(<span class="keyword">function</span>(err) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    console.error(<span class="string">'error connecting: '</span> + err.stack);</span><br><span class="line">    <span class="built_in">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  console.log(<span class="string">'connected as id '</span> + connection.threadId);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是，也可以通过调用查询来隐式建立连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var mysql      = require(<span class="string">'mysql'</span>);</span><br><span class="line">var connection = mysql.createConnection(...);</span><br><span class="line"> </span><br><span class="line">connection.query(<span class="string">'SELECT 1'</span>, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  // connected!</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以根据你喜好来处理你的错误，任何一种方法都可能是合适的。任何类型的连接错误（握手或网络）都被视为致命错误，请参阅错误处理部分以获取更多信息。</p>
<a id="more"></a>
<h2 id="连接可配置选项"><a href="#连接可配置选项" class="headerlink" title="连接可配置选项"></a>连接可配置选项</h2><p>建立连接时，可以设置以下选项：</p>
<blockquote>
<p>1、 <font color="#00B050">host：您要连接的数据库的主机地址。（默认值： localhost）</font><br>2、 <font color="#00B050">port：连接主机的端口号。（默认值：3306）</font><br>3、 localAddress：用于TCP连接的源IP地址。（可选）<br>4、 socketPath：unix域套接字连接的路径。在使用时host 和port被忽略。<br>5、 <font color="#00B050">user：MySQL用户身份验证。</font><br>6、 <font color="#00B050">password：该MySQL用户的密码。</font><br>7、 <font color="#00B050">database：将要连接到的数据库的名称。</font><br>8、 charset：连接的字符集。这在MySQL的SQL级别（如utf8_general_ci）中被称为“整理” 。如果指定了SQL级别的字符集（比如utf8mb4），那么将使用该字符集的默认排序规则。（默认值：’UTF8_GENERAL_CI’）<br>9、 timezone：在MySQL服务器上配置的时区。这用于将服务器日期/时间值转换为JavaScript Date对象，反之亦然。这可以是’local’，’Z’或者是在形式+HH:MM或者偏移量上-HH:MM。（默认值：’local’）<br>10、 connectTimeout：在初始连接到MySQL服务器期间发生超时之前的毫秒数。（默认值：10000）<br>11、 stringifyObjects：将对象进行字符串化，而不是转换为值。见问题＃501。（默认值：false）<br>12、 insecureAuth：允许连接到请求旧（不安全）身份验证方法的MySQL实例。（默认值：false）<br>13、 typeCast：确定是否应将列值转换为本机JavaScript类型。（默认值：true）<br>14、 queryFormat：自定义查询格式功能。见自定义格式。<br>15、 supportBigNumbers：在数据库中处理大数字（BIGINT和DECIMAL列）时，应该启用此选项（默认：）false。bigNumberStrings：启用supportBigNumbers并bigNumberStrings强制大数字（BIGINT和DECIMAL列）始终以JavaScript String对象的形式返回（默认：）false。启用supportBigNumbers但留下bigNumberStrings禁用仅当它们不能准确地表示为字符串对象返回大数字的JavaScript Number对象 （当它们超过[-2 ^ 53，+ 2 ^ 53]范围这恰好），否则它们将被返回作为数对象。如果supportBigNumbers被禁用，该选项将被忽略。<br>16、 dateStrings：强制日期类型（TIMESTAMP，DATETIME，DATE）作为字符串返回，而不是充满JavaScript Date对象。可以是true/ false或一个类型名称数组保持为字符串。（默认值：false）<br>17、 debug：将协议详细信息打印到标准输出。可以是true/ false应该打印的数据包类型名称的数组。（默认值：false）<br>18、 trace：生成堆栈轨迹Error以包含库入口的调用位置（“长堆栈轨迹”）。大多数通话的性能会受到轻微影响。（默认值：true）<br>19、 <font color="#00B050">multipleStatements：允许每个查询多个mysql语句。注意这一点，这可能会增加SQL注入攻击的范围。（默认值：false）在调用存储过程时需要设置为true。</font><br>20、 flags：使用非默认连接标志的连接标志列表。黑名单也是可能的。有关更多信息，请检查 连接标志。<br>21、 ssl：带有ssl参数的对象或包含ssl配置文件名称的字符串。请参阅SSL选项。</p>
</blockquote>
<p>除了将这些选项作为对象传递外，还可以使用url字符串进行数据库链接。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var connection = mysql.createConnection(<span class="string">'mysql://user:pass@host/db?debug=true&amp;charset=BIG5_CHINESE_CI&amp;timezone=-0700'</span>);</span><br></pre></td></tr></table></figure>
<font color="red">注意：MYSQL会优先尝试将查询值解析为JSON，如果失败则假定为纯文本字符串返回。</font>

<h2 id="SSL选项"><a href="#SSL选项" class="headerlink" title="SSL选项"></a>SSL选项</h2><p>ssl在连接选项需要一个字符串或对象。给定一个字符串时，它使用一个预定义的SSL配置文件。包括以下配置文件：</p>
<p>“Amazon RDS”：此配置文件用于连接到Amazon RDS服务器，并包含 <a href="https://rds.amazonaws.com/doc/rds-ssl-ca-cert.pem" target="_blank" rel="noopener">https://rds.amazonaws.com/doc/rds-ssl-ca-cert.pem</a> 和 <a href="https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem连接到其他服务器时，需要提供选项对象，格式与crypto.createCredentials相同。请注意，参数需要一个证书字符串，而不是证书的文件名。这是一个简单的例子：" target="_blank" rel="noopener">https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem连接到其他服务器时，需要提供选项对象，格式与crypto.createCredentials相同。请注意，参数需要一个证书字符串，而不是证书的文件名。这是一个简单的例子：</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var connection = mysql.createConnection(&#123;</span><br><span class="line">  host : <span class="string">'localhost'</span>,</span><br><span class="line">  ssl  : &#123;</span><br><span class="line">    ca : fs.readFileSync(__dirname + <span class="string">'/mysql-ca.crt'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>您也可以不填写ssl直接连接到MySQL服务器，但不能正确提供合适的CA的信任。但这是不合法的操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var connection = mysql.createConnection(&#123;</span><br><span class="line">  host : <span class="string">'localhost'</span>,</span><br><span class="line">  ssl  : &#123;</span><br><span class="line">       //  不要这样做</span><br><span class="line">       //  正确设置你的ca来获取连接信任</span><br><span class="line">    rejectUnauthorized: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="终止链接"><a href="#终止链接" class="headerlink" title="终止链接"></a>终止链接</h2><p>有两种方法可以结束连接。通过调用end()方法完成终止连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connection.end(<span class="keyword">function</span>(err) &#123;</span><br><span class="line">  // 终止链接</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这将确保所有以前排队的查询仍然在发送 COM_QUIT数据包到MySQL服务器。如果COM_QUIT在发送数据包之前就已经发生致命错误，则会 向回调函数提供err参数，但连接将被终止。<br>另一种结束连接的方式是调用destroy()方法。这将导致底层套接字的立即终止。此外destroy()保证没有更多的事件或回调将引发的连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection.destroy();</span><br></pre></td></tr></table></figure>
<p>destroy()方法与end()方法不同，destroy()不需要回调参数。</p>
<h2 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h2><p>这个模块不是一个接一个地创建和管理连接，而是使用内置的连接池mysql.createPool(config)。 阅读有关连接池的更多信息。</p>
<h3 id="直接使用连接池"><a href="#直接使用连接池" class="headerlink" title="直接使用连接池"></a>直接使用连接池</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var mysql = require(<span class="string">'mysql'</span>);</span><br><span class="line">var pool  = mysql.createPool(&#123;</span><br><span class="line">  connectionLimit : 10,</span><br><span class="line">  host            : <span class="string">'example.org'</span>,</span><br><span class="line">  user            : <span class="string">'bob'</span>,</span><br><span class="line">  password        : <span class="string">'secret'</span>,</span><br><span class="line">  database        : <span class="string">'my_db'</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">pool.query(<span class="string">'SELECT 1 + 1 AS solution'</span>, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  console.log(<span class="string">'查询到的结果是: '</span>, results[0].solution);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="集中连接"><a href="#集中连接" class="headerlink" title="集中连接"></a>集中连接</h3><p>可以集中连接以简化共享单个连接或管理多个连接的操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var mysql = require(<span class="string">'mysql'</span>);</span><br><span class="line">var pool  = mysql.createPool(&#123;</span><br><span class="line">  host     : <span class="string">'example.org'</span>,</span><br><span class="line">  user     : <span class="string">'bob'</span>,</span><br><span class="line">  password : <span class="string">'secret'</span>,</span><br><span class="line">  database : <span class="string">'my_db'</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">pool.getConnection(<span class="keyword">function</span>(err, connection) &#123;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当你完成一个连接，只要使用指令connection.release()，就可以连接将返回到池，准备再次被别人使用。（使用完连接池的连接一定要关闭）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var mysql = require(<span class="string">'mysql'</span>);</span><br><span class="line">var pool  = mysql.createPool(...);</span><br><span class="line"> </span><br><span class="line">pool.getConnection(<span class="keyword">function</span>(err, connection) &#123;</span><br><span class="line">    //  使用连接  </span><br><span class="line">    connection.query(<span class="string">'SELECT something FROM sometable'</span>, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line"> 	    //  抛出查询过程中遇到的错误</span><br><span class="line">    <span class="keyword">if</span> (error) throw error;</span><br><span class="line">        //  这里可以得到查询结果</span><br><span class="line">        //  完成连接。</span><br><span class="line">        connection.release();//关闭连接，连接返回连接池</span><br><span class="line">        //  不要在这里使用连接，它已经返回到池中。</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果要关闭连接并将其从连接池中删除，可以使用 connection.destroy()。连接池将在下一次需要时创建一个新的连接。<br>连接是由连接池创建的。如果将连接池池配置为允许多达100个连接，如果只是使用5个连接，那么只生成5个连接。连接也采用循环的方式，连接从连接池的顶部被取出并返回到底部。<br>当从池中检索到以前的连接时，会将ping数据包发送到服务器以检查连接是否仍然良好。</p>
<h2 id="连接池选项"><a href="#连接池选项" class="headerlink" title="连接池选项"></a>连接池选项</h2><p>连接池支持所有与连接相同的选项。当创建一个新的连接时，这些选项只是传递给连接构造函数。除了这些选项之外，池还可以接受一些附加功能：</p>
<blockquote>
<p>1、 acquireTimeout：在连接获取期间发生超时的毫秒数。这与connectTimeout稍有不同，因为获取池连接并不涉及建立连接。（默认值：10000）<br>2、 waitForConnections：当没有可用的连接并连接数到限制时。如果设置为true池将连接请求排队，并在有可用时调用它。如果设置为false，池会立即回拨错误。（默认值：true）<br>3、 connectionLimit：一次创建的最大连接数。（默认值：10）<br>4、 queueLimit：设置连接池中排队的最大连接请求数。如果设置为0，排队的连接请求的数量没有限制。（默认值：0）</p>
</blockquote>
<h2 id="连接池事件"><a href="#连接池事件" class="headerlink" title="连接池事件"></a>连接池事件</h2><h3 id="acquire"><a href="#acquire" class="headerlink" title="acquire"></a>acquire</h3><p>从连接池中获取连接时，连接池池将发出一个事件。这是在连接完成所有获取活动之后，在连接被传递到代码的回调之前调用的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool.on(<span class="string">'acquire'</span>, <span class="keyword">function</span> (connection) &#123;</span><br><span class="line">  console.log(<span class="string">'获取到连接！'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="connection"><a href="#connection" class="headerlink" title="connection"></a>connection</h3><p>在池中connection建立新的连接时，池将发出一个事件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool.on(<span class="string">'connection'</span>, <span class="keyword">function</span> (connection) &#123;</span><br><span class="line">  connection.query(<span class="string">'SET SESSION auto_increment_increment=1'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="enqueue"><a href="#enqueue" class="headerlink" title="enqueue"></a>enqueue</h3><p>enqueue当排队等待可用连接时，池将发出一个事件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool.on(<span class="string">'enqueue'</span>, <span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">  console.log(<span class="string">'等待可用的连接！'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h3><p>release连接释放回池时池将发出一个事件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool.on(<span class="string">'release'</span>, <span class="keyword">function</span> (connection) &#123;</span><br><span class="line">  console.log(<span class="string">'连接被释放！'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="关闭连接池中所有的连接"><a href="#关闭连接池中所有的连接" class="headerlink" title="关闭连接池中所有的连接"></a>关闭连接池中所有的连接</h2><p>当你使用连接池时，你必须结束所有连接，否则Node.js事件循环将保持活动状态，直到MySQL服务器关闭连接。这通常是在脚本中使用连接池池或尝试正常关闭服务器时完成的。要结束池中的所有连接，请使用连接池池中的end方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool.end(<span class="keyword">function</span> (err) &#123;</span><br><span class="line">  // 关闭连接在连接池中的所有连接</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="多主机连接poolcluster"><a href="#多主机连接poolcluster" class="headerlink" title="多主机连接poolcluster"></a>多主机连接poolcluster</h2><p>poolcluster提供多个主机连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个连接池集群</span><br><span class="line">var poolCluster = mysql.createPoolCluster();</span><br><span class="line"> </span><br><span class="line">// 为连接池集群添加配置</span><br><span class="line">poolCluster.add(config); //使用自动名称添加配置</span><br><span class="line">poolCluster.add(<span class="string">'MASTER'</span>, masterConfig); // 添加一个命名的配置</span><br><span class="line">poolCluster.add(<span class="string">'SLAVE1'</span>, slave1Config);</span><br><span class="line">poolCluster.add(<span class="string">'SLAVE2'</span>, slave2Config);</span><br><span class="line"> </span><br><span class="line">// 删除配置</span><br><span class="line">poolCluster.remove(<span class="string">'SLAVE2'</span>); // 删除具体名称的节点配置poolCluster.remove(<span class="string">'SLAVE*'</span>); // 删除SLAVE开头的配置 </span><br><span class="line">//全部连接池组 </span><br><span class="line">poolCluster.getConnection(<span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line"> </span><br><span class="line">// MASTER连接池组</span><br><span class="line">poolCluster.getConnection(<span class="string">'MASTER'</span>, <span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line"> </span><br><span class="line">//监听删除集群中的配置节点 </span><br><span class="line">poolCluster.on(<span class="string">'remove'</span>, <span class="keyword">function</span> (nodeId) &#123;</span><br><span class="line">  console.log(<span class="string">'节点: '</span> + nodeId+’已被删除！’);&#125;);</span><br><span class="line"> </span><br><span class="line">// 可以使*进行匹配节点</span><br><span class="line">poolCluster.getConnection(<span class="string">'SLAVE*'</span>, <span class="string">'ORDER'</span>, <span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line"> </span><br><span class="line">//可以使用正则进行节点匹配 </span><br><span class="line">poolCluster.getConnection(/^SLAVE[12]$/, <span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line"> </span><br><span class="line">// 获取所有的节点连接池poolCluster.of(<span class="string">'*'</span>).getConnection(<span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line"> </span><br><span class="line">var pool = poolCluster.of(<span class="string">'SLAVE*'</span>, <span class="string">'RANDOM'</span>);</span><br><span class="line">pool.getConnection(<span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line">pool.getConnection(<span class="keyword">function</span> (err, connection) &#123;&#125;);</span><br><span class="line">pool.query(<span class="keyword">function</span> (error, results, fields) &#123;&#125;);</span><br><span class="line"> </span><br><span class="line">//关闭所有的连接池集群的连接 </span><br><span class="line">poolCluster.end(<span class="keyword">function</span> (err) &#123;</span><br><span class="line">  // 所有连接池集群中的连接全部关闭了</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="poolCluster选项"><a href="#poolCluster选项" class="headerlink" title="poolCluster选项"></a>poolCluster选项</h2><blockquote>
<p>1、 canRetry:如果true，PoolCluster会尝试连接失败时重新连接。（默认值：true）<br>2、 removeNodeErrorCount：如果连接失败，节点的errorCount增加。当errorCount大于时removeNodeErrorCount，删除一个节点PoolCluster。（默认值：5）<br>3、 restoreNodeTimeout：如果连接失败，则指定在进行另一次连接尝试之前的毫秒数。如果设置为0，则节点将被删除，而不会被重新使用。（默认值：0）<br>        defaultSelector：默认选择器。（默认值：RR）<br>        RR：交替选择一个。（轮循调度）<br>        RANDOM：通过随机函数选择节点。<br>        ORDER：无条件选择可用的第一个节点。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var  clusterConfig  = &#123; </span><br><span class="line">    removeNodeErrorCount ：1 ，//  连接失败时立即删除节点。  </span><br><span class="line">    defaultSelector ：<span class="string">' ORDER '</span> </span><br><span class="line">&#125; ;</span><br><span class="line"> </span><br><span class="line">var  poolCluster  = mysql.createPoolCluster （ clusterConfig ） ;</span><br></pre></td></tr></table></figure>
<h2 id="切换登录用户"><a href="#切换登录用户" class="headerlink" title="切换登录用户"></a>切换登录用户</h2><p>MySQL提供了一个changeUser命令，允许你在不关闭底层套接字的情况下改变连接的当前用户和其他方面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.changeUser(&#123;user : <span class="string">'john'</span>&#125;, <span class="keyword">function</span>(err) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) throw err;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这个功能的可用选项是：</p>
<blockquote>
<p>1、 user：新用户的名称（默认为前一个）。<br>2、 password：新用户的密码（默认为前一个）。<br>3、 charset：新的字符集（默认是前一个）。<br>4、 database：新的数据库（默认为前一个）。<br>这个功能有时候有用的副作用是这个函数也重置任何连接状态（变量，事务等）。<br>此操作过程中遇到的错误被视为由该模块致命的连接错误。</p>
</blockquote>
<h2 id="服务器断开连接"><a href="#服务器断开连接" class="headerlink" title="服务器断开连接"></a>服务器断开连接</h2><p>由于网络问题，服务器计时，服务器重新启动或崩溃，您可能会失去与MySQL服务器的连接。所有这些事件被认为是致命的错误，并将有err.code = ‘PROTOCOL_CONNECTION_LOST’。有关更多信息，请参阅错误处理部分。<br>通过建立一个新的连接重新连接一个连接。一旦终止，现有的连接对象不能通过设计重新连接。<br>使用Pool时，断开的连接将从池中移除，释放空间，以便在下一次getConnection调用时创建新连接。</p>
<h2 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h2><p>最简单的形式。query()是.query(sqlString, callback)，其中第一个参数是SQL字符串，第二个是回调：</p>
<h3 id="第一种方式："><a href="#第一种方式：" class="headerlink" title="第一种方式："></a>第一种方式：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT * FROM `books` WHERE `author` = "David"'</span>, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">    // error:在查询中产生的错误</span><br><span class="line">    // results：是查询成功后的查询结果</span><br><span class="line">    // fields：将包含有关返回的结果字段的信息（如果有的话）</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="第二种形式"><a href="#第二种形式" class="headerlink" title="第二种形式"></a>第二种形式</h3><p>.query(sqlString, values, callback)来使用占位符值（请参阅转义查询值）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection.query （<span class="string">' SELECT * FROM`books` WHERE`author` =？'</span>，[ <span class="string">' David '</span> ] ，<span class="keyword">function</span> （error ，results ，fields ） &#123;      </span><br><span class="line">    //  错误将是一个错误，如果在查询期间发生的一个</span><br><span class="line">    //  结果将包含查询的结果</span><br><span class="line">    //  字段将包含有关返回的结果字段的信息（如果有的话）</span><br><span class="line">&#125; ） ;</span><br></pre></td></tr></table></figure>
<h3 id="第三种形式"><a href="#第三种形式" class="headerlink" title="第三种形式"></a>第三种形式</h3><p>.query(options, callback)在查询中使用各种高级选项（如转义查询值， 具有重叠列名称的联接， 超时和类型转换）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connection.query(&#123;</span><br><span class="line">    sql: <span class="string">'SELECT * FROM `books` WHERE `author` = ?'</span>,</span><br><span class="line">    timeout: 40000, // 40s</span><br><span class="line">    values: [<span class="string">'David'</span>]</span><br><span class="line">&#125;, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">    //  错误将是一个错误，如果在查询期间发生的一个</span><br><span class="line">    //  结果将包含查询的结果</span><br><span class="line">    //  字段将包含有关返回的结果字段的信息（如果有的话）</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="转义查询"><a href="#转义查询" class="headerlink" title="转义查询"></a>转义查询</h3><p>为了避免SQL注入攻击，在SQL查询中使用数据之前，应该始终转义任何用户提供的数据。你可以这样做使用 mysql.escape()，connection.escape()或pool.escape()方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var userId = <span class="string">'some user provided value'</span>;</span><br><span class="line">var sql    = <span class="string">'SELECT * FROM users WHERE id = '</span> + connection.escape(userId);</span><br><span class="line">connection.query(sql, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) throw error;</span><br><span class="line">    // ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>或者，您可以使用?字符作为您想要像这样转义的值的占位符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT * FROM users WHERE id = ?'</span>, [userId], <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) throw error;</span><br><span class="line">    // ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>多个占位符以与传递相同的顺序映射到值。例如，在下面的查询fooequals a，barequals b，bazequals c和 id将是userId：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'UPDATE users SET foo = ?, bar = ?, baz = ? WHERE id = ?'</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, userId], <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) throw error;</span><br><span class="line">    // ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这看起来类似于MySQL中的预处理语句，但它实际上只是在connection.escape()内部使用相同的方法。</p>
<font color="red">注意事项 所有?语句都能被替换，即使是注释和字符串中包含的语句也是如此。</font>

<p>不同的值类型有不同的转义，这里是：</p>
<blockquote>
<p>1、 数字保持不变<br>2、 布尔转为true/false<br>3、 日期对象转换为’YYYY-mm-dd HH:ii:ss’字符串<br>4、 缓冲区被转换为十六进制字符串，例如 X’0fa5’<br>5、 字符串安全地逃脱<br>6、 数组变成列表，例如[‘a’, ‘b’]变成’a’, ‘b’<br>7、 嵌套数组变成分组列表（用于批量插入），例如[[‘a’, ‘b’], [‘c’, ‘d’]]变成(‘a’, ‘b’), (‘c’, ‘d’)<br>8、 具有toSqlString方法的对象将.toSqlString()被调用，并将返回的值用作原始SQL。<br>9、 对象key = ‘val’对于对象上的每个可枚举属性都是成对的。如果属性的值是一个函数，则跳过它; 如果该属性的值是一个对象，则调用toString（）并使用返回的值。<br>10、 undefined/ null被转换为NULL<br>11、 NaN/ Infinity保持原样。MySQL不支持这些，试图插入它们作为值将触发MySQL错误，直到他们实现支持。</p>
</blockquote>
<p>这个转义允许你做这样的整洁的事情：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var post  = &#123;id: 1, title: <span class="string">'Hello MySQL'</span>&#125;;</span><br><span class="line">var query = connection.query(<span class="string">'INSERT INTO posts SET ?'</span>, post, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) throw error;</span><br><span class="line">    // Neat!</span><br><span class="line">&#125;);</span><br><span class="line">console.log(query.sql);</span><br><span class="line">// INSERT INTO posts SET `id` = 1, `title` = <span class="string">'Hello MySQL'</span></span><br></pre></td></tr></table></figure>
<h2 id="转义查询标识符"><a href="#转义查询标识符" class="headerlink" title="转义查询标识符"></a>转义查询标识符</h2><p>如果因为它是由用户提供的，你不能相信一个SQL标识符（数据库/表/列名），你应该避面mysql.escapeId(identifier)，connection.escapeId(identifier)或者pool.escapeId(identifier)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var sorter = <span class="string">'date'</span>;</span><br><span class="line">var sql    = <span class="string">'SELECT * FROM posts ORDER BY '</span> + connection.escapeId(sorter);</span><br><span class="line">connection.query(sql, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  // ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>它也支持添加合格的标识符。它会逃脱这两个部分。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var sorter = <span class="string">'date'</span>;</span><br><span class="line">var sql    = <span class="string">'SELECT * FROM posts ORDER BY '</span> + connection.escapeId(<span class="string">'posts.'</span> + sorter);</span><br><span class="line">// -&gt; SELECT * FROM posts ORDER BY `posts`.`date`</span><br></pre></td></tr></table></figure>
<p>如果您不想将其.视为限定标识符，则可以将第二个参数设置true为将字符串保留为文字标识符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var sorter = <span class="string">'date.2'</span>;</span><br><span class="line">var sql    = <span class="string">'SELECT * FROM posts ORDER BY '</span> + connection.escapeId(sorter, <span class="literal">true</span>);</span><br><span class="line">// -&gt; SELECT * FROM posts ORDER BY `date.2`</span><br></pre></td></tr></table></figure>
<p>或者，您可以使用??字符作为您希望像这样转义的标识符的占位符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var userId = 1;</span><br><span class="line">var columns = [<span class="string">'username'</span>, <span class="string">'email'</span>];</span><br><span class="line">var query = connection.query(<span class="string">'SELECT ?? FROM ?? WHERE id = ?'</span>, [columns, <span class="string">'users'</span>, userId], <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  // ...</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">console.log(query.sql); // SELECT `username`, `email` FROM `users` WHERE id = 1</span><br></pre></td></tr></table></figure>
<p><font color="red">注意，这最后一个字符序列是实验性的，语法可能会改变</font><br>当你传递一个Object，.escape()和.query()、.escapeId()是用来避免在对象键中进行SQL注入。</p>
<h2 id="准备查询"><a href="#准备查询" class="headerlink" title="准备查询"></a>准备查询</h2><p>你可以使用mysql.format准备一个带有多个插入点的查询，利用正确的转义ID和值。一个简单的例子如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var sql = <span class="string">"SELECT * FROM ?? WHERE ?? = ?"</span>;</span><br><span class="line">var inserts = [<span class="string">'users'</span>, <span class="string">'id'</span>, userId];</span><br><span class="line">sql = mysql.format(sql, inserts);</span><br></pre></td></tr></table></figure>
<p>在此之后，您将获得有效的转义查询，然后您可以安全地将其发送到数据库。如果您希望在将查询发送到数据库之前准备查询，这非常有用。由于mysql.format是从SqlString.format公开的，你也可以选择（但不是必须的）传入stringifyObject和timezone，允许你提供一个把对象转换成字符串的自定义方式。</p>
<h2 id="获取插入行的ID"><a href="#获取插入行的ID" class="headerlink" title="获取插入行的ID"></a>获取插入行的ID</h2><p>如果使用自动增量主键将一行插入表中，则可以像这样检索插入标识：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'INSERT INTO posts SET ?'</span>, &#123;title: <span class="string">'test'</span>&#125;, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  console.log(results.insertId);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="获取受影响行数"><a href="#获取受影响行数" class="headerlink" title="获取受影响行数"></a>获取受影响行数</h2><p>您可以从插入，更新或删除语句中获取受影响的行数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'DELETE FROM posts WHERE title = "wrong"'</span>, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  console.log(<span class="string">'deleted '</span> + results.affectedRows + <span class="string">' rows'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="获取更改的行数"><a href="#获取更改的行数" class="headerlink" title="获取更改的行数"></a>获取更改的行数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'UPDATE posts SET ...'</span>, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) throw error;</span><br><span class="line">  console.log(<span class="string">'changed '</span> + results.changedRows + <span class="string">' rows'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="获取连接ID"><a href="#获取连接ID" class="headerlink" title="获取连接ID"></a>获取连接ID</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.connect(<span class="keyword">function</span>(err) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) throw err;</span><br><span class="line">  console.log(<span class="string">'connected as id '</span> + connection.threadId);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="并行执行查询"><a href="#并行执行查询" class="headerlink" title="并行执行查询"></a>并行执行查询</h2><p>MySQL协议是顺序的，这意味着你需要多个连接来并行执行查询。您可以使用Pool来管理连接，一个简单的方法是为每个传入的http请求创建一个连接。</p>
<h2 id="流式查询"><a href="#流式查询" class="headerlink" title="流式查询"></a>流式查询</h2><p>有时您可能需要大量的回调嵌套。您这可以这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var query = connection.query(<span class="string">'SELECT * FROM posts'</span>);</span><br><span class="line">query</span><br><span class="line">  .on(<span class="string">'error'</span>, <span class="keyword">function</span>(err) &#123;</span><br><span class="line">     // 查询过程中产生的错误</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'fields'</span>, <span class="keyword">function</span>(fields) &#123;</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">  .on(<span class="string">'result'</span>, <span class="keyword">function</span>(row) &#123;</span><br><span class="line">        // 查询到的结果</span><br><span class="line">        connection.pause();</span><br><span class="line">        processRow(row, <span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">        connection.resume();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'end'</span>, <span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">     // 关闭连接</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="用流管道结果"><a href="#用流管道结果" class="headerlink" title="用流管道结果"></a>用流管道结果</h2><p>查询对象提供了.stream([options])将查询事件封装到可读流 对象中。这个流很容易被传递到下游管道，并提供自动暂停/恢复，基于下游拥塞和可选highWaterMark。objectMode流的参数被设置为true和不能被改变（如果你需要一个字节流，你需要使用一个变换流，例如objstream）。<br>例如，将管道查询结果导入另一个流（最大缓冲区为5个对象）只是简单的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">'SELECT * FROM posts'</span>)</span><br><span class="line">  .stream(&#123;highWaterMark: 5&#125;)</span><br><span class="line">  .pipe(...);</span><br></pre></td></tr></table></figure>
<h2 id="多语句查询"><a href="#多语句查询" class="headerlink" title="多语句查询"></a>多语句查询</h2><p>对于多个语句的支持由于安全原因被禁用（如果值未正确转义，则允许SQL注入攻击）。要使用此功能，您必须为您的连接启用它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var connection = mysql.createConnection(&#123;multipleStatements: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>你可以查询多条SQL语句并且输出多个语句的查询结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var query = connection.query(<span class="string">'SELECT 1; SELECT 2'</span>);</span><br><span class="line"> </span><br><span class="line">query</span><br><span class="line">  .on(<span class="string">'fields'</span>, <span class="keyword">function</span>(fields, index) &#123;</span><br><span class="line">        // 后面的结果行的字段</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'result'</span>, <span class="keyword">function</span>(row, index) &#123;</span><br><span class="line">        // 索引指这个结果所属的语句（从0开始）</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><p>您可以像查询任何其他mysql驱动程序一样从查询中调用存储过程。如果存储过程生成多个结果集，则它们将以与多个语句查询的结果相同的方式显示给您。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var conn=mysql.createConnection(&#123;</span><br><span class="line">    host:<span class="string">'127.0.0.1'</span>,</span><br><span class="line">    user:<span class="string">'root'</span>,</span><br><span class="line">    password:<span class="string">'root_pwd'</span>,</span><br><span class="line">    database:<span class="string">'db_name'</span>,</span><br><span class="line">    multipleStatements:<span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line">conn.connect(()=&gt;&#123;</span><br><span class="line">    var sql=<span class="string">"CALL insertUser('tom:'123',@result)"</span>;SELECT @result;</span><br><span class="line">    conn.query(sql,(err,result)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(err)throw err;</span><br><span class="line">        console.log(result);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h2><p>每个操作都有一个可选的不活动超时选项。这使您可以指定适当的操作超时。需要注意的是，这些超时不是MySQL协议的一部分，而是通过客户端的超时操作。这意味着当超时达到时，发生的连接将被破坏，不能进行进一步的操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 60秒后杀死查询</span><br><span class="line">connection.query(&#123;sql: <span class="string">'SELECT COUNT(*) AS count FROM big_table'</span>, timeout: 60000&#125;, <span class="keyword">function</span> (error, results, fields) &#123;</span><br><span class="line">  <span class="keyword">if</span> (error &amp;&amp; error.code === <span class="string">'PROTOCOL_SEQUENCE_TIMEOUT'</span>) &#123;</span><br><span class="line">    throw new Error(<span class="string">'计算行数太长!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    throw error;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  console.log(results[0].count + <span class="string">' rows'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
                </div>
            </article>
            
                <div id="rewardBox">
    <a href="javascript:;" class="reward-btn"><i class="fa fa-credit-card"></i>打赏支持</a>
    <div id="reward-modal-container">
        <div class="reward-modal-background">
            <div class="reward-modal">
                <p class="reward-quote">
                    <i class="reward-quote-left"></i>
                    <span class="reward-quote-word">如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!</span>
                    <i class="reward-quote-right"></i>
                </p>
                <div class="reward-tab">
                    <a href="javascript:;" class="reward-wechat active" data-index="0">微信</a>
                    <a href="javascript:;" class="reward-alipay" data-index="1">支付宝</a>
                    <img src="http://ziyuan.qikepower.com/wx.png" alt="wechat" class="reward-image active">
                    <img src="http://ziyuan.qikepower.com/zfb.jpg" alt="alipay" class="reward-image">
                </div>
            </div>
        </div>
    </div></div>
            
            
            
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    // gitalk的主要参数
    clientID: "5b8d35f0aa2ff3fb215f",
    clientSecret: "f2d66b4efccabb319e5c269a201ccfabafe61344",
    repo: "zhaodongming.github.io",
    owner: "zhaodongming",
    admin: '645394545@qq.com',
    id: "node-MYSQL"
  });
  gitalk.render('gitalk-container');
</script>
            
        </div>
        <aside>

            <!--<div class="wxcode">
    <img src="http://ziyuan.qikepower.com/qrcode_for_gh_dc857c884228_430.jpg" alt="">
    <h6 class="text-center">扫码关注个人公众号</h6>
</div>-->
            <!--<div class="flinkBox">
    <div class="fltitle">
        <h2>友情链接</h2>
    </div>
    <div class="fl_list">
        <ul>
            
                <li><a href="https://jdc.jd.com" target="_blank" title="京东设计中心">京东设计中心</a></li>
            
                <li><a href="http://dopro.io/" target="_blank" title="Deep Ocean">Deep Ocean</a></li>
            
                <li><a href="http://fex.baidu.com" target="_blank" title="百度Web前端研发部">百度Web前端研发部</a></li>
            
        </ul>
    </div>
</div>-->
            <div id="navfixed" class="postNav">
    <div class="fltitle">
        <h2>文章目录</h2>
    </div>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装node-mysql"><span class="toc-number">1.</span> <span class="toc-text">安装node-mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立连接"><span class="toc-number">2.</span> <span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接可配置选项"><span class="toc-number">3.</span> <span class="toc-text">连接可配置选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSL选项"><span class="toc-number">4.</span> <span class="toc-text">SSL选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#终止链接"><span class="toc-number">5.</span> <span class="toc-text">终止链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接池"><span class="toc-number">6.</span> <span class="toc-text">连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#直接使用连接池"><span class="toc-number">6.1.</span> <span class="toc-text">直接使用连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集中连接"><span class="toc-number">6.2.</span> <span class="toc-text">集中连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接池选项"><span class="toc-number">7.</span> <span class="toc-text">连接池选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接池事件"><span class="toc-number">8.</span> <span class="toc-text">连接池事件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#acquire"><span class="toc-number">8.1.</span> <span class="toc-text">acquire</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#connection"><span class="toc-number">8.2.</span> <span class="toc-text">connection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enqueue"><span class="toc-number">8.3.</span> <span class="toc-text">enqueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Release"><span class="toc-number">8.4.</span> <span class="toc-text">Release</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关闭连接池中所有的连接"><span class="toc-number">9.</span> <span class="toc-text">关闭连接池中所有的连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多主机连接poolcluster"><span class="toc-number">10.</span> <span class="toc-text">多主机连接poolcluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#poolCluster选项"><span class="toc-number">11.</span> <span class="toc-text">poolCluster选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#切换登录用户"><span class="toc-number">12.</span> <span class="toc-text">切换登录用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务器断开连接"><span class="toc-number">13.</span> <span class="toc-text">服务器断开连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行查询"><span class="toc-number">14.</span> <span class="toc-text">执行查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一种方式："><span class="toc-number">14.1.</span> <span class="toc-text">第一种方式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二种形式"><span class="toc-number">14.2.</span> <span class="toc-text">第二种形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三种形式"><span class="toc-number">14.3.</span> <span class="toc-text">第三种形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转义查询"><span class="toc-number">14.4.</span> <span class="toc-text">转义查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#转义查询标识符"><span class="toc-number">15.</span> <span class="toc-text">转义查询标识符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备查询"><span class="toc-number">16.</span> <span class="toc-text">准备查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取插入行的ID"><span class="toc-number">17.</span> <span class="toc-text">获取插入行的ID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取受影响行数"><span class="toc-number">18.</span> <span class="toc-text">获取受影响行数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取更改的行数"><span class="toc-number">19.</span> <span class="toc-text">获取更改的行数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取连接ID"><span class="toc-number">20.</span> <span class="toc-text">获取连接ID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#并行执行查询"><span class="toc-number">21.</span> <span class="toc-text">并行执行查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流式查询"><span class="toc-number">22.</span> <span class="toc-text">流式查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用流管道结果"><span class="toc-number">23.</span> <span class="toc-text">用流管道结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多语句查询"><span class="toc-number">24.</span> <span class="toc-text">多语句查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储过程"><span class="toc-number">25.</span> <span class="toc-text">存储过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#超时"><span class="toc-number">26.</span> <span class="toc-text">超时</span></a></li></ol>
</div>
        </aside>

    </div>
</section>
<div class="backtop" id="backTop" style="display: block;">
    <i class="fa fa-long-arrow-up"></i>
</div>
</main>
<footer id="footer">
    <div class="container">
        <p> 由
            <a href="http://hexo.io/" target="_blank">Hexo</a>
            和
            <a href="https://github.com/zhaodongming/hexo-theme-baozi" target="_blank">Hexo-theme-baozi</a> 提供支持
        </p>
        <p id="copyRightEn">版权所有 © 2013 - 2019 明 All Rights Reserved.</p>
        <p class="busuanzi_uv">
            访客数 : <span id="busuanzi_value_site_uv"></span> |
            访问量 : <span id="busuanzi_value_site_pv"></span>
        </p>
    </div>
</footer>
<script src="/js/jquery.js"></script>
<script src="/js/main.js"></script>
<script src="/js/busuanzi.pure.mini.js"></script>
<script src="/js/bootstrap.min.js"></script>
</body>
</html>